# .github/workflows/cleanup.yml
name: üßπ D·ªçn D·∫πp L·ªãch S·ª≠ Ch·∫°y C·ªßa Workflow

on:
  schedule:
    # Cron Job: Ch·∫°y m·ªói tu·∫ßn m·ªôt l·∫ßn v√†o Th·ª© Hai l√∫c 01:00 AM UTC
    # (T∆∞∆°ng ƒë∆∞∆°ng 8:00 AM gi·ªù Vi·ªát Nam)
    - cron: '0 1 * * 1'
  workflow_dispatch: # Cho ph√©p ch·∫°y th·ªß c√¥ng khi c·∫ßn

jobs:
  delete_runs:
    runs-on: ubuntu-latest
    
    # R·∫§T QUAN TR·ªåNG: C·∫ßn quy·ªÅn ghi (write) cho Actions ƒë·ªÉ x√≥a l·ªãch s·ª≠ ch·∫°y
    permissions:
      actions: write
      contents: read

    steps:
      - name: üóëÔ∏è X√≥a L·ªãch S·ª≠ Ch·∫°y B·∫±ng GitHub API (Gi·∫£i ph√°p ƒë√°ng tin c·∫≠y)
        uses: actions/github-script@v7 # Action ch√≠nh th·ª©c c·ªßa GitHub, √≠t b·ªã l·ªói
        id: cleanup
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflowId = 'Podcast Generator - Full Pipeline (Final Fix)';
            const repo = context.repo;
            const retainDays = 7;
            const oneWeekAgo = new Date(Date.now() - retainDays * 24 * 60 * 60 * 1000);

            console.log(`B·∫Øt ƒë·∫ßu t√¨m ki·∫øm runs c·ªßa workflow: ${workflowId}`);

            // 1. T√¨m Workflow ID
            const { data: workflows } = await github.rest.actions.listRepoWorkflows({
              owner: repo.owner,
              repo: repo.repo,
            });
            
            const targetWorkflow = workflows.workflows.find(w => w.name === workflowId);
            
            if (!targetWorkflow) {
              console.log(`L·ªói: Kh√¥ng t√¨m th·∫•y Workflow c√≥ t√™n '${workflowId}'`);
              return;
            }

            console.log(`T√¨m th·∫•y ID: ${targetWorkflow.id}. B·∫Øt ƒë·∫ßu li·ªát k√™ runs...`);

            // 2. Li·ªát k√™ v√† X√≥a c√°c Runs
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: repo.owner,
              repo: repo.repo,
              workflow_id: targetWorkflow.id,
              status: 'completed', // Ch·ªâ x√≥a c√°c l·∫ßn ch·∫°y ƒë√£ ho√†n th√†nh
            });

            let runsDeleted = 0;

            for (const run of runs.workflow_runs) {
              const runDate = new Date(run.created_at);
              
              // N·∫øu run c≈© h∆°n 7 ng√†y
              if (runDate < oneWeekAgo) {
                console.log(`ƒêang x√≥a run ID ${run.id} (${run.created_at})`);
                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner: repo.owner,
                    repo: repo.repo,
                    run_id: run.id,
                  });
                  runsDeleted++;
                } catch (error) {
                  console.log(`Kh√¥ng th·ªÉ x√≥a run ${run.id}: ${error.message}`);
                }
              }
            }

            console.log(`‚úÖ Ho√†n t·∫•t d·ªçn d·∫πp. T·ªïng s·ªë runs ƒë√£ x√≥a: ${runsDeleted}`);
