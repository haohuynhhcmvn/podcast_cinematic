name: üéôÔ∏è Podcast Generator - Ultra Optimized Pipeline

on:
  workflow_dispatch: 

jobs:
  build_and_upload_podcast:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    # ƒê·ªäNH NGHƒ®A BI·∫æN M√îI TR∆Ø·ªúNG ·ªû ƒê√ÇY
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
      # T√™n bi·∫øn n√†y PH·∫¢I kh·ªõp v·ªõi bi·∫øn os.getenv() trong fetch_content.py
      GOOGLE_SERVICE_ACCOUNT_JSON_CONTENT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON_CONTENT }} 

    steps:
      - name: ‚¨áÔ∏è Checkout m√£ ngu·ªìn
        uses: actions/checkout@v4

      - name: üíæ Cache FFmpeg
        id: cache-ffmpeg
        uses: actions/cache@v4
        with:
          path: /usr/bin/ffmpeg
          key: ${{ runner.os }}-ffmpeg

      - name: ‚öôÔ∏è C√†i ƒë·∫∑t FFmpeg & ImageMagick (Fast install)
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg imagemagick -qq
          sudo sed -i 's/none/read,write/g' /etc/ImageMagick-6/policy.xml

      - name: üêç Thi·∫øt l·∫≠p Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: üì¶ C√†i ƒë·∫∑t th∆∞ vi·ªán Python
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: üîë Thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng & Credentials
        run: |
          # 1. V·ª´a t·∫°o file (ph√≤ng h·ªù) v·ª´a gi·ªØ bi·∫øn m√¥i tr∆∞·ªùng
          echo "$GOOGLE_SERVICE_ACCOUNT_JSON_CONTENT" > service-account.json
          
          # 2. Gi·∫£i m√£ c√°c token YouTube
          echo "${{ secrets.YOUTUBE_CLIENT_SECRET_B64 }}" | base64 --decode > client_secrets.json
          echo "${{ secrets.YOUTUBE_TOKEN_PICKLE_B64 }}" | base64 --decode > token.pickle
          
          # 3. T·∫°o file .env
          cat <<EOF > .env
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          GOOGLE_SHEET_ID=${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON_CONTENT='$GOOGLE_SERVICE_ACCOUNT_JSON_CONTENT'
          EOF

      - name: üöÄ Ch·∫°y Glue Pipeline (Parallel Mode)
        run: python scripts/glue_pipeline.py

      - name: üßπ D·ªçn d·∫πp Workspace
        if: always()
        run: rm -f token.pickle client_secrets.json service-account.json .env
