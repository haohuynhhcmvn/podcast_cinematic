name: Podcast Auto Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"  # Chạy mỗi 30 phút

jobs:
  build-podcast:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout code
      - uses: actions/checkout@v3

      # 2. Cài đặt FFmpeg (Bắt buộc cho xử lý video/audio)
      - name: Install apt deps (FFmpeg)
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      # 3. Cài đặt Python 3.11
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # 4. Cài đặt các thư viện Python
      - name: Install pip deps
        run: pip install -r requirements.txt
        
      # 5. TẠO FILE SERVICE ACCOUNT JSON TỪ SECRET
      # Bước này lấy nội dung JSON từ Secret GSPREAD_SERVICE_ACCOUNT và tạo file thật
      - name: Create Service Account File
        run: echo '${{ secrets.GSPREAD_SERVICE_ACCOUNT }}' > service_account.json
        env:
          GSPREAD_SERVICE_ACCOUNT: ${{ secrets.GSPREAD_SERVICE_ACCOUNT }}

      # 6. Thiết lập biến môi trường (API Keys)
      - name: Set Environment Variables
        run: |
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
          echo "YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}" >> $GITHUB_ENV
          echo "ENVS loaded"
          
      # 7. Chạy Pipeline chính
      - name: Run pipeline
        run: python scripts/glue_pipeline.py
